{% extends "web_page/layout.html" %}

{% block body %}
<h2 class="my-4">Упоредно читање</h2>
<div class="controls">
    <div>
        <label for="book1">Књ. 1:</label>
        <select id="book1">
            <option value="">--Одабери књигу--</option>
            {% for book in books %}
            <option value="{{ book.id }}">{{ book.title }}</option>
            {% endfor %}
        </select>
    </div>

    <div>
        <label for="book2">Књ. 2:</label>
        <select id="book2">
            <option value="">--Одабери књигу--</option>
            {% for book in books %}
            <option value="{{ book.id }}">{{ book.title }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Add checkbox for showing entire chapter -->
    <div>
        <label for="showChapter">
            <input type="checkbox" id="showChapter">
        </label>
    </div>

    <div class="search-container">
        <input type="text" id="searchBar" placeholder="Претрага стихова">
        <!-- Add "i" button with tooltip -->
        <button id="searchInfo" class="info-button" aria-label="Search Help">i</button>
        <div id="searchTooltip" class="tooltip">
            <strong>Оператори претраге:</strong><br>
            - Користи <code>&</code> за И (нпр., <code>фарисеј&садукеј</code>).<br>
            - Користи <code>|</code> за ИЛИ (нпр., <code>фарисеј|садукеј</code>).<br>
            - Користи <code>!</code> за НЕ (нпр., <code>!фарисеј</code>).<br>
        </div>
    </div>
</div>

<div class="verses-container">
    <div id="verses1"></div>
    <div id="verses2"></div>
</div>

<!-- JavaScript -->
<script>
 // Add event listeners for dropdowns
document.getElementById('book1').addEventListener('change', function() {
    const bookId = this.value;
    if (bookId) {
        fetchVerses(bookId, 'verses1');
    } else {
        document.getElementById('verses1').innerHTML = '';
    }
});

document.getElementById('book2').addEventListener('change', function() {
    const bookId = this.value;
    if (bookId) {
        fetchVerses(bookId, 'verses2');
    } else {
        document.getElementById('verses2').innerHTML = '';
    }
});

// Add event listener for search bar
document.getElementById('searchBar').addEventListener('input', function() {
    const searchText = this.value.toLowerCase();
    filterVerses('verses1', searchText);
    filterVerses('verses2', searchText);
});

// Add event listener for the checkbox
document.getElementById('showChapter').addEventListener('change', function() {
    const searchText = document.getElementById('searchBar').value.toLowerCase();
    filterVerses('verses1', searchText);
    filterVerses('verses2', searchText);
});

// Fetch verses from the server
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrfToken = getCookie('csrftoken');

function fetchVerses(bookId, targetDivId) {
    fetch(`/fetch/${bookId}/`, {
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const versesHtml = data.verses.map(verse => {
            if (verse.verse_number === 0) {
                // Format for heading verses
                return `<div class="verse" data-chapter="${verse.chapter}" data-verse-number="${verse.verse_number}">
                            <strong>${verse.chapter}</strong> <em>${verse.verse}</em>
                        </div>`;
            } else {
                // Format for regular verses
                return `<div class="verse" data-chapter="${verse.chapter}" data-verse-number="${verse.verse_number}">
                            <strong>${verse.chapter}:${verse.verse_number}</strong> ${verse.verse}
                        </div>`;
            }
        }).join('');
        document.getElementById(targetDivId).innerHTML = versesHtml;
    })
    .catch(error => {
        console.error('Error fetching verses:', error);
        document.getElementById(targetDivId).innerHTML = `<p style="color: red;">Error loading verses: ${error.message}</p>`;
    });
}

function filterVerses(targetDivId, searchText) {
    const verses = document.querySelectorAll(`#${targetDivId} .verse`);
    const searchTerms = searchText.toLowerCase().split(/\s+/); // Split search text into terms
    const showChapter = document.getElementById('showChapter').checked;

    // Helper function to check if a verse matches the search terms
    function matchesSearch(verseText, terms) {
        let result = true;
        terms.forEach(term => {
            if (term.startsWith('!')) {
                // NOT operator: term should NOT be present
                if (verseText.includes(term.slice(1))) {
                    result = false;
                }
            } else if (term.includes('&')) {
                // AND operator: all sub-terms must be present
                const subTerms = term.split('&');
                if (!subTerms.every(subTerm => verseText.includes(subTerm))) {
                    result = false;
                }
            } else if (term.includes('|')) {
                // OR operator: at least one sub-term must be present
                const subTerms = term.split('|');
                if (!subTerms.some(subTerm => verseText.includes(subTerm))) {
                    result = false;
                }
            } else {
                // Default: term must be present
                if (!verseText.includes(term)) {
                    result = false;
                }
            }
        });
        return result;
    }

    // Get all chapters in the current container
    const chapters = new Set();
    const matchingChapters = new Set();

    verses.forEach(verse => {
        const chapter = verse.getAttribute('data-chapter');
        const verseText = verse.textContent.toLowerCase();

        if (matchesSearch(verseText, searchTerms)) {
            matchingChapters.add(chapter); // Mark the chapter as containing a match
        }

        chapters.add(chapter); // Add all chapters to the set
    });

    // Filter verses
    verses.forEach(verse => {
        const chapter = verse.getAttribute('data-chapter');
        const verseText = verse.textContent.toLowerCase();
        const matches = matchesSearch(verseText, searchTerms);

        if (showChapter) {
            // If showChapter is checked, show all verses in the matching chapter
            if (matchingChapters.has(chapter)) {
                verse.style.display = '';
            } else {
                verse.style.display = 'none';
            }
        } else {
            // Show only the matching verse when checkbox is unchecked
            if (matches) {
                verse.style.display = '';
            } else {
                verse.style.display = 'none';
            }
        }
    });
}

</script>

<style>
.verses-container {
    height: 80vh; /* Adjust the height as needed */
}

#verses1, #verses2 {
    flex: 1;
    overflow-y: auto; /* Enable vertical scrolling */
    border: 1px solid #ccc; /* Optional: Add a border for better visibility */
    padding: 10px;
    height: 100%; /* Ensure the container takes up the full height */
}
</style>
{% endblock %}
